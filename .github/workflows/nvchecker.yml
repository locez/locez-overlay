name: Check Package Updates
on:
  schedule:
    - cron: "0 2 * * *" # Run daily at 02:00 UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install nvchecker jq packaging

      - name: Run nvchecker and compare
        id: check_updates
        run: |
          # Check for new versions
          CONF=".github/workflows/nvchecker.toml"
          nvchecker -c $CONF

          # Compare with previous versions and output to JSON
          # If no updates are found, create an empty array to avoid errors
          nvcmp -c $CONF --json > updates.json || echo "[]" > updates.json

          echo "Updates detected:"
          cat updates.json

      - name: Create individual issues for updates
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Iterate through each update entry in the JSON array
          cat updates.json | jq -c '.[]' | while read -r pkg; do
            NAME=$(echo "$pkg" | jq -r '.name')
            OLD=$(echo "$pkg" | jq -r '.oldver')
            NEW=$(echo "$pkg" | jq -r '.newver')

            EXPECTED_TITLE="[nvchecker] $NAME: $OLD -> $NEW"


            # 1. Search for an existing open issue (retrieve both number and title)
            # jq '.[0]' takes the first result; returns null if nothing is found
            EXISTING=$(gh issue list --state open --search "[nvchecker] $NAME" --json number,title --jq '.[0]')
            
            # Extract issue number and title
            ISSUE_NUM=$(echo "$EXISTING" | jq -r '.number')
            CURRENT_TITLE=$(echo "$EXISTING" | jq -r '.title')

            if [ "$ISSUE_NUM" != "null" ]; then
              # --- Case A: Issue exists ---
              echo "Found open issue #$ISSUE_NUM for $NAME"

              if [ "$CURRENT_TITLE" != "$EXPECTED_TITLE" ]; then
                echo "Version bumped again! Updating issue #$ISSUE_NUM..."

                # Update the title to the latest version
                gh issue edit "$ISSUE_NUM" --title "$EXPECTED_TITLE"

                # Add a comment to notify that the version has changed again
                gh issue comment "$ISSUE_NUM" --body "ðŸš€ **Update detected**: Upstream version has been updated to \`$NEW\` (the version in the previous title is now outdated)."
              else
                echo "Issue is up-to-date. Skipping."
              fi
            else
              # --- Case B: Issue does not exist, create a new one ---
              echo "Creating new issue for $NAME..."

              BODY=$(cat <<EOF
                New version detected by nvchecker:
                **Package**: \`$NAME\`
                **Current version**: \`$OLD\`
                **New version**: \`$NEW\`

          Please update the ebuild when you have time.
          EOF
          )

             gh issue create \
                --title "$EXPECTED_TITLE" \
                --body "$BODY" \
                --label "nvchecker"
            fi
          done

      - name: Persist version changes
        run: |
          # Sync known versions to avoid re-notifying on next run
          CONF=".github/workflows/nvchecker.toml"
          RECORD_FILE=".github/old_versions.json"
          nvtake -c $CONF --all

          # Commit updated version records back to the repository
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          if [ -f "$RECORD_FILE" ]; then
            git add "$RECORD_FILE"
            git commit -m "chore: update nvchecker version records [skip ci]" || echo "No changes to commit"
            git push
          else
            echo "Error: $RECORD_FILE not found!"
            exit 1
          fi
